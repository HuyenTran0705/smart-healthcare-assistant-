from gtts import gTTS
import speech_recognition as sr
from openai import OpenAI
import pygame, os, time, tempfile

client = OpenAI(
  base_url="https://openrouter.ai/api/v1",
  api_key="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",
)

robot_ear = sr.Recognizer()
robot_brain = ""
pygame.mixer.init()

while True:

    with sr.Microphone() as mic:
        print("Robot: T√¥i ƒëang nghe...")
        audio = robot_ear.listen(mic)
        print("Robot: ...")

    try:
        you = robot_ear.recognize_google(audio, language="vi-VN")
    except:
        you = ""

    print("B·∫°n: " + you)

    # üö™ N·∫øu nghe th·∫•y "t·∫°m bi·ªát" ho·∫∑c "bye" th√¨ tho√°t lu√¥n
    if "t·∫°m bi·ªát" in you or "bye" in you:
        print("Robot: Ch√†o t·∫°m bi·ªát! H·∫πn g·∫∑p l·∫°i b·∫°n üëã")
        break


    try: 
        completion = client.chat.completions.create(
            extra_headers={
            "HTTP-Referer": "<YOUR_SITE_URL>", # Optional. Site URL for rankings on openrouter.ai.
            "X-Title": "<YOUR_SITE_NAME>", # Optional. Site title for rankings on openrouter.ai.
            },
            extra_body={},
            model="deepseek/deepseek-r1-0528:free",
            messages=[
            {
                "role": "system",
                "content": "B·∫°n l√† m·ªôt tr·ª£ l√Ω AI th√¥ng minh, tr·∫£ l·ªùi ng·∫Øn g·ªçn."
            }, 
            {
                "role": "user",
                "content": you
            }
            ],
            temperature=0.7,
       )
        robot_brain = completion.choices[0].message.content
    except: 
        robot_brain = "Xin l·ªói, vui l√≤ng th·ª≠ l·∫°i sau."
    

    print("Robot:" + robot_brain)

    # ==== T·∫°o file mp3 t·∫°m, ph√°t xong th√¨ x√≥a ====
    try:
        # file t·∫°m v·ªõi t√™n duy nh·∫•t
        tmp_path = os.path.join(tempfile.gettempdir(), f"voice_{int(time.time()*1000)}.mp3")
        gTTS(text=robot_brain, lang='vi').save(tmp_path)

        pygame.mixer.music.load(tmp_path)
        pygame.mixer.music.play()

        # ch·ªù ph√°t xong
        clock = pygame.time.Clock()
        while pygame.mixer.music.get_busy():
            clock.tick(10)

        # gi·∫£i ph√≥ng v√† x√≥a file ƒë·ªÉ l·∫ßn sau kh√¥ng b·ªã lock
        try:
            pygame.mixer.music.unload()  # c·∫ßn pygame 2.x
        except:
            pass
        if os.path.exists(tmp_path):
            os.remove(tmp_path)
    except Exception as e:
        print("L·ªói ph√°t √¢m thanh:", e)

   
  
